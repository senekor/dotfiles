#!/bin/bash
set -euo pipefail

# update once a week: {{ output "date" "+%Y-%V" | trim }}

echo "Making sure prebuilt binaries are installed..."

if ! which mise &> /dev/null ; then
    curl https://mise.run | sh
else
    mise self-update -y || true
fi

if ! which cargo-binstall &> /dev/null ; then
    echo "installing cargo-binstall..."
    curl -L --proto '=https' --tlsv1.2 -sSf \
        https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh \
        | bash
fi

packages=(
    cargo-binstall # self-update
    starship
    zellij
    jj-cli
    ccase
    watchexec-cli
    choose
    sd
    eza
    xh
    usage-cli # used by mise
    mergiraf
    typos-cli
)
cargo binstall --no-confirm --log-level warn "${packages[@]}"

# I don't use `mise use -g` because I don't currently "activate" mise in every
# shell session. I also don't generate shims. I just want regular binaries.
mise_tools=(
    marksman
)
for tool in "${mise_tools[@]}" ; do
    if ! which "$tool" > /dev/null ; then
        mise install-into "$tool@latest" "/tmp/$tool-install"
        mv "/tmp/$tool-install/$tool" ~/.local/bin
    fi
done
